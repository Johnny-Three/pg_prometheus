\set ECHO ALL
\set ON_ERROR_STOP 1
SET TIME ZONE 'UTC';
DROP TABLE IF EXISTS metrics_labels CASCADE;
NOTICE:  table "metrics_labels" does not exist, skipping
DROP TABLE IF EXISTS metrics CASCADE;
NOTICE:  table "metrics" does not exist, skipping
DROP TABLE IF EXISTS input;
NOTICE:  table "input" does not exist, skipping
SELECT create_prometheus_table('input', 'metrics', keep_samples=>true);
 create_prometheus_table 
-------------------------
 
(1 row)

\d input
       Table "public.input"
 Column |    Type     | Modifiers 
--------+-------------+-----------
 sample | prom_sample | not null
Triggers:
    insert_trigger BEFORE INSERT ON input FOR EACH ROW EXECUTE PROCEDURE prometheus.insert_metric('metrics', 'metrics_labels', 't')

\d metrics
              Table "public.metrics"
  Column   |           Type           | Modifiers 
-----------+--------------------------+-----------
 time      | timestamp with time zone | 
 value     | double precision         | 
 labels_id | integer                  | 
Indexes:
    "metrics_labels_id_idx" btree (labels_id)
    "metrics_time_idx" btree ("time")
Foreign-key constraints:
    "metrics_labels_id_fkey" FOREIGN KEY (labels_id) REFERENCES metrics_labels(id)

\d metrics_labels
                            Table "public.metrics_labels"
   Column    |  Type   |                          Modifiers                          
-------------+---------+-------------------------------------------------------------
 id          | integer | not null default nextval('metrics_labels_id_seq'::regclass)
 metric_name | text    | not null
 labels      | jsonb   | 
Indexes:
    "metrics_labels_pkey" PRIMARY KEY, btree (id)
    "metrics_labels_metric_name_labels_key" UNIQUE CONSTRAINT, btree (metric_name, labels)
    "metrics_labels_labels_idx" gin (labels)
    "metrics_labels_metric_name_idx" btree (metric_name)
Referenced by:
    TABLE "metrics" CONSTRAINT "metrics_labels_id_fkey" FOREIGN KEY (labels_id) REFERENCES metrics_labels(id)

INSERT INTO input VALUES ('cpu_usage{service="nginx",host="machine1"} 34.6 1494595898000'),
                         ('cpu_usage{service="nginx",host="machine2"} 10.3 1494595899000'),
                         ('cpu_usage{service="nginx",host="machine1"} 30.2 1494595928000');
SELECT * FROM input;
                               sample                               
--------------------------------------------------------------------
 cpu_usage{service="nginx",host="machine1"} 34.600000 1494595898000
 cpu_usage{service="nginx",host="machine2"} 10.300000 1494595899000
 cpu_usage{service="nginx",host="machine1"} 30.200000 1494595928000
(3 rows)

SELECT * FROM metrics;
             time             | value | labels_id 
------------------------------+-------+-----------
 Fri May 12 13:31:38 2017 UTC |  34.6 |         1
 Fri May 12 13:31:39 2017 UTC |  10.3 |         2
 Fri May 12 13:32:08 2017 UTC |  30.2 |         1
(3 rows)

SELECT * FROM metrics_labels;
 id | metric_name |                  labels                  
----+-------------+------------------------------------------
  1 | cpu_usage   | {"host": "machine1", "service": "nginx"}
  2 | cpu_usage   | {"host": "machine2", "service": "nginx"}
(2 rows)

-- Cleanup
DROP TABLE metrics CASCADE;
DROP TABLE metrics_labels CASCADE;
DROP TABLE input;
-- Test inserts without keeping original samples
SELECT create_prometheus_table('input', 'metrics');
 create_prometheus_table 
-------------------------
 
(1 row)

INSERT INTO input VALUES ('cpu_usage{service="nginx",host="machine1"} 34.6 1494595898000');
SELECT * FROM input;
 sample 
--------
(0 rows)

SELECT * FROM metrics;
             time             | value | labels_id 
------------------------------+-------+-----------
 Fri May 12 13:31:38 2017 UTC |  34.6 |         1
(1 row)

-- Cleanup
DROP TABLE metrics CASCADE;
DROP TABLE metrics_labels CASCADE;
DROP TABLE input;
